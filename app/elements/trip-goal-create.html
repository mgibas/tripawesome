<link rel="import" href="../bower_components/polymer/polymer.html">
<dom-module id="trip-goal-create">
    <template>
        <style include="shared-styles iron-flex">
        :host {
            display: block;
        }

        trip-goal-search-item {
            width: 100%;
        }

        [title] {
            pointer-events: all !important;
        }

        app-toolbar {
            background-color: #FFF
        }
        </style>
        <firebase-document id="fb" app-name="tripawesome" data="{{_newGoal}}"></firebase-document>
        <google-map-search id="search" api-key="AIzaSyDIaWkbQnlyk4iRyNNAGtNudHsjQTdC2qg" map="[[map]]" query="[[_debouncedSearchQuery]]" results="{{places}}" radius="100000" types="point_of_interest amusement_park aquarium art_gallery library bakery bar cafe movie_theater campground museum night_club park casino cemetery church city_hall restaurant shopping_mall spa stadium synagogue zoo neighborhood">
        </google-map-search>
        <google-map api-key="AIzaSyDIaWkbQnlyk4iRyNNAGtNudHsjQTdC2qg" map="{{map}}" latitude="[[latitude]]" longitude="[[longitude]]"></google-map>
        <canvas id="canvas" hidden width="10"></canvas>
        <paper-listbox selected-item="{{_selectedPlace}}">
            <template is="dom-repeat" items="[[places]]" as="item">
                <paper-item item="[[item]]">
                    <trip-goal-search-item item="[[item]]"></trip-goal-search-item>
                </paper-item>
            </template>
        </paper-listbox>
        <paper-fab icon="check" class="action-right" hidden$="[[!_selected]]"></paper-fab>
    </template>
    <script>
    (() => {
        'use strict';
        class TripGoalCreate {
            get is() {
                return 'trip-goal-create';
            }
            get properties() {
                return {
                    searchValue: {
                        type: String,
                        observer: '_searchValueChanged'
                    },
                    _canSelect: {
                        type: Boolean,
                        value: false
                    },
                    _selectedPlace: {
                        type: Object
                    },
                    _selected: {
                        type: Boolean,
                        value: false,
                        computed: '_computeSelected(_selectedPlace)'
                    }
                };
            }
            save() {
                this._newGoal = {
                    tripKey: this.key,
                    location: {
                        name: this._selectedPlace.item.name,
                        placeId: this._selectedPlace.item.place_id,
                        latitude: this._selectedPlace.item.latitude,
                        longitude: this._selectedPlace.item.longitude
                    }
                };

                this._prepareImages()
                    .then(() => {
                        return this.$.fb.save(`/goals`);
                    })
                    .then(() => {
                        this.$.fb.reset();
                        this._newGoal = {};
                        this.fire('created');
                    });
            }
            reset() {
                this.searchValue = null;
                this.places = null;
            }
            _computeSelected(selectedPlace) {
                return !!selectedPlace;
            }
            _searchValueChanged(value) {
                this.debounce('update-search-query', () => {
                    this._debouncedSearchQuery = this.searchValue;
                }, 200);
            }
            _prepareImages() {
                return new Promise((resolve, reject) => {
                    if (this._selectedPlace.item.photos.length === 0) resolve();

                    this._newGoal.location.photoUrl = this._selectedPlace.item.photos[0].getUrl({
                        maxWidth: 2000,
                        maxHeight: 2000
                    });
                    this._newGoal.location.thumbnailUrl = this._selectedPlace.item.photos[0].getUrl({
                        maxWidth: 100,
                        maxHeight: 100
                    });
                    var ratio = this._selectedPlace.item.photos[0].width / this._selectedPlace.item.photos[0].height;
                    var placeholderUrl = this._selectedPlace.item.photos[0].getUrl({
                        maxWidth: 10,
                        maxHeight: Math.floor(10 / ratio)
                    });
                    this._imageToBase64(placeholderUrl)
                        .then((placeholder) => {
                            this._newGoal.location.placeholder = placeholder;
                            resolve();
                        });
                });
            }
            _imageToBase64(url) {
                return new Promise((resolve, reject) => {
                    var img = new Image();
                    img.onload = () => {
                        this.$.canvas.height = img.height;
                        this.$.canvas.width = img.width;
                        var context = this.$.canvas.getContext('2d');
                        context.drawImage(img, 0, 0, this.$.canvas.width, this.$.canvas.height);
                        resolve(this.$.canvas.toDataURL('image/jpeg'));
                    };
                    img.crossOrigin = 'Anonymous';
                    img.src = url;
                });
            }
        }
        Polymer(TripGoalCreate);
    })();
    </script>
</dom-module>
