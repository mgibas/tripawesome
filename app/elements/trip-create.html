<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="trip-create">
    <template>
        <style include="shared-styles iron-flex iron-flex-alignment">
        :host {
            display: block;
            @apply(--layout-vertical);
        }
        </style>
        <firebase-document id="fb" app-name="tripawesome" data="{{newTrip}}"></firebase-document>
        <google-map-search global-search="true" map="[[map]]" query="[[_debouncedSearchQuery]]" results="{{locations}}" types="locality">
        </google-map-search>
        <google-map map="{{map}}"></google-map>
        <app-header condenses reveals>
            <app-toolbar>
                <paper-icon-button icon="arrow-back" on-tap="_cancel"></paper-icon-button>
                <div title>
                    Create Trip
                </div>
                <paper-button on-tap="_create">Save</paper-button>
            </app-toolbar>
        </app-header>
        <paper-material class="flex">
            <paper-input label="Name" value="{{newTrip.name}}"></paper-input>
            <paper-input value="{{_searchQuery}}" label="Search For Something To Do"></paper-input>
            <paper-listbox selected-item="{{_selectedLocation}}">
                <template is="dom-repeat" items="[[locations]]" as="item">
                    <paper-item item="[[item]]">[[item.name]]</paper-item>
                </template>
            </paper-listbox>
        </paper-material>
    </template>
    <script>
    (() => {
        'use strict';

        class TripCreate {
            get is() {
                return 'trip-create';
            }
            get properties() {
                return {
                    _searchQuery: {
                        type: String,
                        observer: '_searchQueryChanged'
                    }
                };
            }
            _cancel() {
                this.newTrip = {};
                this.fire('canceled');
            }
            _create() {
                this.newTrip.location = {
                    name: this._selectedLocation.item.name,
                    placeId: this._selectedLocation.item.place_id,
                    latitude: this._selectedLocation.item.latitude,
                    longitude: this._selectedLocation.item.longitude,
                };
                if (this._selectedLocation.item.photos.length > 0) {
                    this.newTrip.location.photoUrl = this._selectedLocation.item.photos[0].getUrl({
                        maxWidth: 1000,
                        maxHeight: 1000
                    });
                    this.newTrip.location.thumbnailUrl = this._selectedLocation.item.photos[0].getUrl({
                        maxWidth: 100,
                        maxHeight: 100
                    });
                }
                this.$.fb.save('/trips')
                    .then(() => {
                        this.$.fb.reset();
                        this.newTrip = {};
                        this.fire('created');
                    });
            }
            _searchQueryChanged(value) {
                this.debounce('update-search-query', () => {
                    this._debouncedSearchQuery = this._searchQuery;
                }, 200);
            }

        }
        Polymer(TripCreate);
    })();
    </script>
</dom-module>
