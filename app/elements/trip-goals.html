<link rel="import" href="../bower_components/polymer/polymer.html">
<dom-module id="trip-goals">
    <template>
        <style include="iron-flex shared-styles">
        :host {
            display: block;
        }

        trip-goal-item {
            background-color: var(--primary-background-color);
        }

        paper-swipe {
            min-height: 50px;
            @apply(--layout-flex);
            --paper-swipe-underlay: {
                @apply(--layout-horizontal);
                background-color: @apply(--light-accent-color);
            }
            ;
        }

        .delete {
            background-color: var(--danger-color);
            @apply(--layout-horizontal);
            @apply(--layout-center);
            color: #fff;
        }

        .mark {
            @apply(--layout-horizontal);
            @apply(--layout-center);
        }

        .delete paper-icon-button {
            --iron-icon-fill-color: #fff;
        }

        trip-goals-distance,
        trip-goal-item {
            width: 100%;
        }
        </style>
        <google-maps-api id="api" name="distancematrix" api-key="AIzaSyDIaWkbQnlyk4iRyNNAGtNudHsjQTdC2qg"></google-maps-api>
        <paper-listbox>
            <template is="dom-repeat" items="[[_goalsWithDistances]]" as="goal">
                <paper-item>
                    <paper-swipe swipe-right peek-offset="200">
                        <trip-goal-item content item="[[goal]]"></trip-goal-item>
                        <div underlay>
                            <div class="mark">
                                <paper-icon-button icon="check"></paper-icon-button>
                            </div>
                            <div class="flex delete">
                                <paper-icon-button icon="delete"></paper-icon-button>
                                Delete
                            </div>
                        </div>
                    </paper-swipe>
                </paper-item>
                <template is="dom-if" if="{{goal.nextLocationInfo}}">
                    <paper-item disabled="true">
                        <trip-goals-distance info="[[goal.nextLocationInfo]]"></trip-goals-distance>
                    </paper-item>
                </template>
            </template>
        </paper-listbox>
    </template>
    <script>
    (() => {
        'use strict';

        class TripGoals {
            get is() {
                return 'trip-goals';
            }
            get properties() {
                return {
                    _goalsWithDistances: {
                        type: Array,
                        computed: '_computeGoalsWithDistances(goals)'
                    },
                    distances: {
                        type: Object,
                        value: {}
                    }
                };
            }

            _computeGoalsWithDistances(goals) {
                if (!goals) return [];
                var goalsArray = Object.keys(goals).map((k) => goals[k]);
                var pairs = goalsArray.map((goal, index) => {
                        return {
                            from: goal,
                            to: goalsArray[index + 1]
                        };
                    })
                    .filter(pair => pair.to)
                    .filter(pair => !pair.from.nextLocationInfo ||
                        pair.from.nextLocationInfo.placeId !== pair.to.location.placeId ||
                        !pair.from.nextLocationInfo.drivingDistance ||
                        !pair.from.nextLocationInfo.walkingDistance);

                pairs.forEach(pair => {
                    pair.from.nextLocationInfo = {
                        placeId: pair.to.location.placeId,
                        latitude: pair.to.location.latitude,
                        longitude: pair.to.location.longitude
                    };
                    this._getDistance(pair.from);
                });

                return goalsArray;
            }
            _getDistance(goal) {
                var from = new google.maps.LatLng(goal.location.latitude, goal.location.longitude);
                var to = new google.maps.LatLng(goal.nextLocationInfo.latitude, goal.nextLocationInfo.longitude);
                var distanceService = new this.$.api.api.DistanceMatrixService();
                distanceService.getDistanceMatrix({
                    origins: [from],
                    destinations: [to],
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.IMPERIAL
                }, (resp) => {
                    goal.nextLocationInfo.drivingDistance = resp.rows[0].elements[0].distance;
                    goal.nextLocationInfo.drivingDuration = resp.rows[0].elements[0].duration;
                    distanceService.getDistanceMatrix({
                        origins: [from],
                        destinations: [to],
                        travelMode: google.maps.TravelMode.WALKING,
                        unitSystem: google.maps.UnitSystem.IMPERIAL
                    }, (resp) => {
                        goal.nextLocationInfo.walkingDistance = resp.rows[0].elements[0].distance;
                        goal.nextLocationInfo.walkingDuration = resp.rows[0].elements[0].duration;
                        this.fire('goals-updated');
                    });
                });

            }
        }
        Polymer(TripGoals);
    })();
    </script>
</dom-module>
