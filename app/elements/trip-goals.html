<link rel="import" href="../bower_components/polymer/polymer.html">
<dom-module id="trip-goals">
    <template>
        <style include="iron-flex shared-styles">
        :host {
            display: block;
        }

        trip-goals-distance,
        trip-goal-item {
            width: 100%;
        }
        </style>
        <firebase-query id="query" app-name="tripawesome" path="users/[[userUid]]/trip-goals/[[tripKey]]" data="{{goals}}"></firebase-query>
        <paper-listbox>
            <template is="dom-repeat" items="{{goals}}" as="goal" sort="_sortGoals" observe="priority">
                <trip-goals-goal-item key="[[goal.$key]]" trip-key="[[tripKey]]" user-uid="[[userUid]]" on-move-up="_handleMoveUp" on-move-down="_handleMoveDown"></trip-goals-goal-item>
                <trip-goals-distance from="{{goal}}" to="{{_getNextGoal(goal)}}" all-goals="{{goals}}"></trip-goals-distance>
            </template>
        </paper-listbox>
    </template>
    <script>
    (() => {
        'use strict';

        class TripGoals {
            get is() {
                return 'trip-goals';
            }
            get properties() {
                return {
                    tripKey: {
                        type: String
                    },
                    goals: {
                        type: Array
                    }
                };
            }
            _sortGoals(a, b) {
                if (a.priority == b.priority) return 0;
                return a.priority > b.priority ? 1 : -1;
            }
            _getNextGoal(goal) {
                return this.goals.find((g) => g.priority === goal.priority + 1);
            }

            _handleMoveUp(e, currentItem) {
                var previousItem = Polymer.dom(this.root).querySelectorAll('trip-goals-goal-item')
                    .find((item) => item !== currentItem && item.goal.priority === currentItem.goal.priority - 1);

                currentItem.decreasPriority();
                previousItem.increasPriority();
            }

            _handleMoveDown(e, currentItem) {
                var nextItem = Polymer.dom(this.root).querySelectorAll('trip-goals-goal-item')
                    .find((item) => item !== currentItem && item.goal.priority === currentItem.goal.priority + 1);

                currentItem.increasPriority();
                nextItem.decreasPriority();
            }
        }
        Polymer(TripGoals);
    })();
    </script>
</dom-module>
