<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/geo-location/geo-location.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="foursquare-venues-explore">
    <template>
        <iron-ajax id="fsAjax" url="[[_url]]" handle-as="json" method="GET" params="[[_queryParams]]" last-response="{{_lastResponse}}" loading="{{loading}}" debounce-duration="[[debounceDuration]]"></iron-ajax>
        <geo-location id="geolocation" latitude="{{_lat}}" longitude="{{_lng}}"></geo-location>
    </template>
    <script>
        (() => {
            'use strict';
            class FoursquareVenuesExplore {
                get is() {
                    return 'foursquare-venues-explore'
                }
                get properties() {
                    return {
                        config: {
                            type: Object,
                            observer: '_configChanged'
                        },
                        term: {
                            type: String,
                            observer: '_termChanged'
                        },
                        lastResponse: {
                            type: Object,
                            notify: true
                        },
                        loading: {
                            type: Boolean,
                            notify: true
                        },
                        debounceDuration: {
                            type: Number,
                            value: 300
                        },
                        _lastResponse: {
                            type: Object,
                            notify: true,
                            observer: '_lastResponseChanged'
                        },
                        _lat: {
                            type: Number
                        },
                        _lng: {
                            type: Number
                        },
                        _url: {
                            type: String,
                            computed: '_computeUrl(config)'
                        },
                        _queryParams: {
                            type: Object,
                            computed: '_computeQueryParams(_lat,_lng,term)'
                        }
                    };
                }
                _configChanged() {
                    if (!this.config) return;
                    this.$.geolocation.fetch();
                }
                _termChanged(term) {
                    if (!term) return;

                    this.$.fsAjax.generateRequest();
                }
                _computeUrl(config) {
                    return `${config.baseUrl}venues/explore`;
                }
                _computeQueryParams(_lat, _lng, term) {
                    return {
                        ll: `${_lat},${_lng}`,
                        query: term,
                        client_id: this.config.clientId,
                        client_secret: this.config.clientSecret,
                        v: 20160601
                    };
                }
                _lastResponseChanged(response) {
                    var venuse = response.response.groups[0].items.map(({
                        venue
                    }) => venue);
                    this.lastResponse = venuse;
                    console.log(venuse);
                }
            }
            Polymer(FoursquareVenuesExplore);
        })();
    </script>
</dom-module>
